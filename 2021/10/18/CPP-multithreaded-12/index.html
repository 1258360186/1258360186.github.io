<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="blog"><meta name="author" content="ç™½ç¾½è¿‘å¢¨"><title>Linux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡ | ç™½ç¾½å°ç«™</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/mylogo.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"example.com",root:"/",language:"zh-CN",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!1,init_open:!0},style:{primary_color:"#0066CC",avatar:"/images/author.svg",favicon:"/images/mylogo.svg",article_img_align:"center",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"ç§ä¸€æ£µæ ‘ï¼Œæœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰,å…¶æ¬¡æ˜¯ç°åœ¨ã€‚"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,preload:!0},code_copy:{enable:!0,style:"default"},pjax:{enable:!0},lazyload:{enable:!0},version:"3.4.5"},KEEP.language_ago={second:"%s ç§’å‰",minute:"%s åˆ†é’Ÿå‰",hour:"%s å°æ—¶å‰",day:"%s å¤©å‰",week:"%s å‘¨å‰",month:"%s ä¸ªæœˆå‰",year:"%s å¹´å‰"}</script><meta name="generator" content="Hexo 5.4.2"><style>mjx-container[jax=SVG]{direction:ltr}mjx-container[jax=SVG]>svg{overflow:visible}mjx-container[jax=SVG][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=SVG][justify=left]{text-align:left}mjx-container[jax=SVG][justify=right]{text-align:right}g[data-mml-node=merror]>g{fill:red;stroke:red}g[data-mml-node=merror]>rect[data-background]{fill:#ff0;stroke:none}g[data-mml-node=mtable]>line[data-line]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>rect[data-frame]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>.mjx-dashed{stroke-dasharray:140}g[data-mml-node=mtable]>.mjx-dotted{stroke-linecap:round;stroke-dasharray:0,140}g[data-mml-node=mtable]>svg{overflow:visible}[jax=SVG] mjx-tool{display:inline-block;position:relative;width:0;height:0}[jax=SVG] mjx-tool>mjx-tip{position:absolute;top:0;left:0}mjx-tool>mjx-tip{display:inline-block;padding:.2em;border:1px solid #888;font-size:70%;background-color:#f8f8f8;color:#000;box-shadow:2px 2px 5px #aaa}g[data-mml-node=maction][data-toggle]{cursor:pointer}mjx-status{display:block;position:fixed;left:1em;bottom:1em;min-width:25%;padding:.2em .4em;border:1px solid #888;font-size:90%;background-color:#f8f8f8;color:#000}foreignObject[data-mjx-xml]{font-family:initial;line-height:normal;overflow:visible}.MathJax path{stroke-width:3}mjx-container[display=true]{overflow:auto hidden}mjx-container[display=true]+br{display:none}</style><link rel="alternate" href="/atom.xml" title="baiyu" type="application/atom+xml">
<link rel="stylesheet" href="\assets\css\APlayer.min.css" class="aplayer-style-marker">
<script src="\assets\js\APlayer.min.js" class="aplayer-script-marker"></script>
<script src="\assets\js\Meting.min.js" class="meting-script-marker"></script>
</head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fas fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/mylogo.svg"> </a><a class="logo-title" href="/">ç™½ç¾½å°ç«™</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">é¦–é¡µ</a></li><li class="menu-item"><a href="/archives">å½’æ¡£</a></li><li class="menu-item"><a href="/categories">åˆ†ç±»</a></li><li class="menu-item"><a href="/tags">æ ‡ç­¾</a></li><li class="menu-item"><a href="/links">å‹é“¾</a></li><li class="menu-item"><a href="/about">å…³äº</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="/archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="/categories">åˆ†ç±»</a></li><li class="drawer-menu-item flex-center"><a href="/tags">æ ‡ç­¾</a></li><li class="drawer-menu-item flex-center"><a href="/links">å‹é“¾</a></li><li class="drawer-menu-item flex-center"><a href="/about">å…³äº</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Linux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡</span></div><div class="article-header"><div class="avatar"><img src="/images/author.svg"></div><div class="info"><div class="author"><span class="name">ç™½ç¾½è¿‘å¢¨</span> <span class="author-label">Lv5</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp; <span class="pc">2021-10-18 13:56:20</span> <span class="mobile">2021-10-18 13:56</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/C-C-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E7%B2%BE%E9%AB%93/">C/C++ å¤šçº¿ç¨‹ç¼–ç¨‹ç²¾é«“</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Linux/">Linux</a>&nbsp;</li><li>| <a href="/tags/Windows/">Windows</a>&nbsp;</li><li>| <a href="/tags/C-%E5%BC%80%E5%8F%91/">C++ å¼€å‘</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>3k å­—</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>11 åˆ†é’Ÿ</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h4 id="éŸ³ä¹å°æ¸¯"><a href="#éŸ³ä¹å°æ¸¯" class="headerlink" title="éŸ³ä¹å°æ¸¯"></a>éŸ³ä¹å°æ¸¯</h4><div id="aplayer-IFOroEyq" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="2059056" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#555"></div><hr><h1 id="Linux-çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡"><a href="#Linux-çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡" class="headerlink" title="Linux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡"></a>Linux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡</h1><p>æœ‰äººè¯´ Linux æ¡ä»¶å˜é‡ï¼ˆ<code>Condition Variable</code>ï¼‰æ˜¯æœ€ä¸ä¼šç”¨é”™çš„ä¸€ç§çº¿ç¨‹åŒæ­¥å¯¹è±¡ï¼Œç¡®å®æ˜¯è¿™æ ·ï¼Œä½†è¿™å¿…é¡»å»ºç«‹åœ¨ä½ å¯¹æ¡ä»¶å˜é‡ç†Ÿç»ƒä½¿ç”¨çš„åŸºç¡€ä¹‹ä¸Šã€‚æˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ¡ä»¶å˜é‡è¿™æ ·ä¸€ç§æœºåˆ¶ã€‚</p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡"></a>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡</h2><p>å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹éœ€æ±‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//ä»¥ä¸‹æ˜¯ä¼ªç ï¼Œm çš„ç±»å‹æ˜¯ pthread_mutex_tï¼Œå¹¶ä¸”å·²ç»åˆå§‹åŒ–è¿‡äº†</span><br><span class="line">int WaitForTrue()</span><br><span class="line">{</span><br><span class="line">    pthread_mutex_lock(&amp;m);</span><br><span class="line">    while (condition is false)      //æ¡ä»¶ä¸æ»¡è¶³</span><br><span class="line">    {</span><br><span class="line">        pthread_mutex_unlock(&amp;m);   //è§£é”ç­‰å¾…å…¶ä»–çº¿ç¨‹æ”¹å˜ condition</span><br><span class="line">        sleep(n);                   //ç¡çœ nç§’</span><br><span class="line">        //nç§’åå†æ¬¡åŠ é”éªŒè¯æ¡ä»¶æ˜¯å¦æ»¡è¶³</span><br><span class="line">        pthread_mutex_lock(&amp;m);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return 1;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé€»è¾‘å¯ä»¥è¡¨ç¤ºæˆå¦‚ä¸‹æµç¨‹å›¾ï¼š</p><p><img lazyload="" src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/1258360186/image_hosting@master/20210918/multithreaded13.1lhc2y26j7mo.jpg" alt="multithreaded13"></p><p>è¿™æ®µé€»è¾‘çš„ç”¨é€”æ˜¯æˆ‘ä»¬éœ€è¦åå¤åˆ¤æ–­ä¸€ä¸ªå¤šçº¿ç¨‹å…±äº«æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¸€ç›´åˆ°è¯¥æ¡ä»¶æ»¡è¶³ä¸ºæ­¢ï¼Œç”±äºè¯¥æ¡ä»¶è¢«å¤šä¸ªçº¿ç¨‹æ“ä½œå› æ­¤æ¯æ¬¡åˆ¤æ–­ä¹‹å‰éƒ½éœ€è¦è¿›è¡ŒåŠ é”æ“ä½œï¼Œåˆ¤æ–­å®Œæ¯•åéœ€è¦è¿›è¡Œè§£é”æ“ä½œã€‚ä½†æ˜¯ä¸Šè¿°é€»è¾‘å­˜åœ¨ä¸¥é‡çš„æ•ˆç‡é—®é¢˜ï¼Œå‡è®¾è§£é”ç¦»å¼€ä¸´ç•ŒåŒºåï¼Œæ­¤æ—¶ç”±äºå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ¡ä»¶å¯¼è‡´æ¡ä»¶æ»¡è¶³äº†ï¼Œæ­¤æ—¶ç¨‹åºä»ç„¶éœ€è¦ç¡çœ  n ç§’åæ‰èƒ½å¾—åˆ°åé¦ˆã€‚å› æ­¤æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ç§æœºåˆ¶ï¼š</p><blockquote><p>æŸä¸ªçº¿ç¨‹ A åœ¨æ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¸»åŠ¨è®©å‡ºäº’æ–¥é‡ï¼Œè®©å…¶ä»–çº¿ç¨‹å»æŠ˜è…¾ï¼Œçº¿ç¨‹åœ¨æ­¤å¤„ç­‰å¾…ï¼Œç­‰å¾…æ¡ä»¶çš„æ»¡è¶³ï¼›ä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹å°±å¯ä»¥è¢«ç«‹åˆ»å”¤é†’ã€‚çº¿ç¨‹ A ä¹‹æ‰€ä»¥å¯ä»¥å®‰å¿ƒç­‰å¾…ï¼Œä¾èµ–çš„æ˜¯å…¶ä»–çº¿ç¨‹çš„åä½œï¼Œå®ƒç¡®ä¿¡ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å‘ç°æ¡ä»¶æ»¡è¶³ä»¥åï¼Œå°†å‘å®ƒå‘é€ä¿¡å·ï¼Œå¹¶ä¸”è®©å‡ºäº’æ–¥é‡ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹ä¸é…åˆï¼ˆä¸å‘ä¿¡å·ï¼Œä¸è®©å‡ºäº’æ–¥é‡ï¼‰ï¼Œè¿™ä¸ªä¸»åŠ¨è®©å‡ºäº’æ–¥é‡å¹¶ç­‰å¾…äº‹ä»¶å‘ç”Ÿçš„çº¿ç¨‹ A å°±çœŸçš„è¦ç­‰åˆ°èŠ±å„¿éƒ½è°¢äº†ã€‚</p></blockquote><p>è¿™ä¸ªä¾‹å­è§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦æ¡ä»¶ç­‰å¾…ï¼Œä½†æ˜¯æ¡ä»¶ç­‰å¾…è¿˜ä¸æ˜¯æ¡ä»¶å˜é‡çš„å…¨éƒ¨åŠŸèƒ½ã€‚</p><h2 id="æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ"><a href="#æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ" class="headerlink" title="æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ"></a>æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ</h2><p>å¾ˆå¤šç¬¬ä¸€æ¬¡å­¦ä¹  Linux æ¡ä»¶å˜é‡çš„è¯»è€…ä¼šè§‰å¾—å›°æƒ‘ï¼šä¸ºä»€ä¹ˆæ¡ä»¶å˜é‡ä¸€å®šè¦ä¸ä¸€ä¸ªäº’æ–¥ä½“å¯¹è±¡ç»“åˆä½¿ç”¨ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼Œå‡è®¾æ¡ä»¶å˜é‡ä¸ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆçš„æ•ˆæœã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 //mçš„ç±»å‹æ˜¯ pthread_mutex_tï¼Œå¹¶ä¸”å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œcv æ˜¯æ¡ä»¶å˜é‡</span><br><span class="line">2 pthread_mutex_lock(&amp;m)</span><br><span class="line">3 while(condition_is_false)</span><br><span class="line">4 {</span><br><span class="line">5     pthread_mutex_unlock(&amp;m);</span><br><span class="line">6     //è§£é”ä¹‹åï¼Œç­‰å¾…ä¹‹å‰ï¼Œå¯èƒ½æ¡ä»¶å·²ç»æ»¡è¶³ï¼Œä¿¡å·å·²ç»å‘å‡ºï¼Œä½†æ˜¯è¯¥ä¿¡å·å¯èƒ½ä¼šè¢«é”™è¿‡</span><br><span class="line">7     cond_wait(&amp;cv);</span><br><span class="line">8     pthread_mutex_lock(&amp;m);</span><br><span class="line">9 }</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå‡è®¾çº¿ç¨‹ A æ‰§è¡Œå®Œç¬¬ 5 è¡Œä»£ç  <code>pthread_mutex_unlock(&amp;m)</code>; å CPU æ—¶é—´ç‰‡è¢«å‰¥å¤ºï¼Œæ­¤æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹ B è·å¾—è¯¥äº’æ–¥ä½“å¯¹è±¡ mï¼Œç„¶åå‘é€æ¡ä»¶ä¿¡å·ï¼Œç­‰çº¿ç¨‹ A é‡æ–°è·å¾—æ—¶é—´ç‰‡åï¼Œç”±äºè¯¥ä¿¡å·å·²ç»è¢«é”™è¿‡äº†ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹ A åœ¨ ç¬¬ 7 è¡Œ <code>cond_wait(&amp;cv)</code>; æ— é™é˜»å¡ä¸‹å»ã€‚</p><p>é€ æˆè¿™ä¸ªé—®é¢˜çš„æ ¹æºæ˜¯é‡Šæ”¾äº’æ–¥ä½“å¯¹è±¡ä¸æ¡ä»¶å˜é‡ç­‰å¾…å”¤é†’ä¸æ˜¯åŸå­æ“ä½œï¼Œå³è§£é”å’Œç­‰å¾…è¿™ä¸¤ä¸ªæ­¥éª¤å¿…é¡»æ˜¯åŒä¸€ä¸ªåŸå­æ€§çš„æ“ä½œï¼Œä»¥ç¡®ä¿ <code>cond_wait</code> å”¤é†’ä¹‹å‰ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è·å¾—è¿™ä¸ªäº’æ–¥ä½“å¯¹è±¡ã€‚</p><h2 id="æ¡ä»¶å˜é‡çš„ä½¿ç”¨"><a href="#æ¡ä»¶å˜é‡çš„ä½¿ç”¨" class="headerlink" title="æ¡ä»¶å˜é‡çš„ä½¿ç”¨"></a>æ¡ä»¶å˜é‡çš„ä½¿ç”¨</h2><p>ä»‹ç»äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥æ­£å¼ä»‹ç»ä¸€ä¸‹æ¡ä»¶å˜é‡ç›¸å…³çš„ç³»ç»Ÿ API çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>æ¡ä»¶å˜é‡çš„åˆå§‹åŒ–å’Œé”€æ¯å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ API å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int pthread_cond_init(pthread_cond_t* cond, const pthread_condattr_t* attr);</span><br><span class="line">int pthread_cond_destroy(pthread_cond_t* cond);</span><br></pre></td></tr></table></figure><p>åœ¨ Linux ç³»ç»Ÿä¸­ <code>pthread_cond_t</code> å³æ˜¯æ¡ä»¶å˜é‡çš„ç±»å‹ï¼Œå½“ç„¶å’Œå‰é¢ä»‹ç»çš„äº’æ–¥ä½“ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å»åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_cond_t cond = PTHREAD_COND_INITIALIZER;</span><br></pre></td></tr></table></figure><p>ç­‰å¾…æ¡ä»¶å˜é‡çš„æ»¡è¶³å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ API å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int pthread_cond_wait(pthread_cond_t* restrict cond, pthread_mutex_t* restrict mutex);</span><br><span class="line">int pthread_cond_timedwait(pthread_cond_t* restrict cond, pthread_mutex_t* restrict mutex, const struct timespec* restrict abstime);</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æœæ¡ä»¶å˜é‡ä»£è¡¨çš„æ¡ä»¶ä¸ä¼šæ»¡è¶³ï¼Œè°ƒç”¨ <code>pthread_cond_wait</code> çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼›<code>pthread_cond_timedwait</code> æ˜¯ <code>pthread_cond_wait</code> éé˜»å¡ç‰ˆæœ¬ï¼Œå®ƒä¼šåœ¨æŒ‡å®šæ—¶é—´å†…ç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œè¶…è¿‡å‚æ•° <code>abstime</code> è®¾ç½®çš„æ—¶å€™å <code>pthread_cond_timedwait</code> å‡½æ•°ä¼šç«‹å³è¿”å›ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¯¹äºå‚æ•° <code>abstime</code>ï¼Œæ­£å¦‚å…¶åå­—æš—ç¤ºçš„ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>absolute time</code>ï¼ˆç»å¯¹æ—¶é—´ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ æ‰“ç®—è®©å‡½æ•°ç­‰å¾… 5 ç§’ï¼Œé‚£ä¹ˆä½ åº”è¯¥å…ˆå¾—åˆ°å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼Œç„¶ååŠ ä¸Š 5 ç§’è®¡ç®—å‡ºæœ€ç»ˆçš„æ—¶é—´ä½œä¸ºå‚æ•° <code>abstime</code> çš„å€¼ã€‚</p></blockquote><p>å› è°ƒç”¨ <code>pthread_cond_wait</code> ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«ä»¥ä¸‹ API å‡½æ•°å”¤é†’ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int pthread_cond_signal(pthread_cond_t* cond);</span><br><span class="line">int pthread_cond_broadcast(pthread_cond_t* cond);     </span><br></pre></td></tr></table></figure><p><code>pthread_cond_signal</code> ä¸€æ¬¡å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨ <code>pthread_cond_wait</code> ç­‰å¾…ï¼Œå…·ä½“å“ªä¸ªçº¿ç¨‹è¢«å”¤é†’æ˜¯ä¸ç¡®å®šçš„ï¼ˆå¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼‰ï¼›<code>pthread_cond_broadcast</code> å¯ä»¥åŒæ—¶å”¤é†’å¤šä¸ªè°ƒç”¨ <code>pthread_cond_wait</code> ç­‰å¾…çš„çº¿ç¨‹ã€‚å‰è€…ç›¸å½“äºå‘é€ä¸€æ¬¡æ¡ä»¶é€šçŸ¥ï¼Œåè€…å¹¿æ’­ä¸€æ¬¡æ¡ä»¶é€šçŸ¥ã€‚æˆåŠŸç­‰å¾…åˆ°æ¡ä»¶ä¿¡å·ï¼Œ<code>pthread_cond_signal</code> å’Œ <code>pthread_cond_broadcast</code> è¿”å› 0ï¼Œåä¹‹è¿”å›é 0 å€¼ï¼Œå…·ä½“é”™è¯¯åŸå› å¯ä»¥é€šè¿‡é”™è¯¯ç  <code>errno</code> è·å¾—ã€‚</p><p>æˆ‘ä»¬å°†å‰æ–‡ä¸­ä»‹ç»ä¿¡å·é‡çš„ç¤ºä¾‹ä»£ç ç”¨æ¡ä»¶å˜é‡æ¥æ”¹å†™ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;errno.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;list&gt;</span><br><span class="line">#include &lt;semaphore.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">class Task</span><br><span class="line">{</span><br><span class="line">public:</span><br><span class="line">    Task(int taskID)</span><br><span class="line">    {</span><br><span class="line">        this-&gt;taskID = taskID;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    void doTask()</span><br><span class="line">    {</span><br><span class="line">        std::cout &lt;&lt; "handle a task, taskID: " &lt;&lt; taskID &lt;&lt; ", threadID: " &lt;&lt; pthread_self() &lt;&lt; std::endl; </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    int taskID;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">pthread_mutex_t  mymutex;</span><br><span class="line">std::list&lt;Task*&gt; tasks;</span><br><span class="line">pthread_cond_t   mycv;</span><br><span class="line"></span><br><span class="line">void* consumer_thread(void* param)</span><br><span class="line">{    </span><br><span class="line">    Task* pTask = NULL;</span><br><span class="line">    while (true)</span><br><span class="line">    {</span><br><span class="line">        pthread_mutex_lock(&amp;mymutex);</span><br><span class="line">        while (tasks.empty())</span><br><span class="line">        {               </span><br><span class="line">            //å¦‚æœè·å¾—äº†äº’æ–¥é”ï¼Œä½†æ˜¯æ¡ä»¶ä¸åˆé€‚çš„è¯ï¼Œpthread_cond_wait ä¼šé‡Šæ”¾é”ï¼Œä¸å¾€ä¸‹æ‰§è¡Œ</span><br><span class="line">            //å½“å‘ç”Ÿå˜åŒ–åï¼Œæ¡ä»¶åˆé€‚ï¼Œpthread_cond_wait å°†ç›´æ¥è·å¾—é”</span><br><span class="line">            pthread_cond_wait(&amp;mycv, &amp;mymutex);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        pTask = tasks.front();</span><br><span class="line">        tasks.pop_front();</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;mymutex);</span><br><span class="line"></span><br><span class="line">        if (pTask == NULL)</span><br><span class="line">            continue;</span><br><span class="line"></span><br><span class="line">        pTask-&gt;doTask();</span><br><span class="line">        delete pTask;</span><br><span class="line">        pTask = NULL;       </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return NULL;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void* producer_thread(void* param)</span><br><span class="line">{</span><br><span class="line">    int taskID = 0;</span><br><span class="line">    Task* pTask = NULL;</span><br><span class="line"></span><br><span class="line">    while (true)</span><br><span class="line">    {</span><br><span class="line">        pTask = new Task(taskID);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;mymutex);</span><br><span class="line">        tasks.push_back(pTask);</span><br><span class="line">        std::cout &lt;&lt; "produce a task, taskID: " &lt;&lt; taskID &lt;&lt; ", threadID: " &lt;&lt; pthread_self() &lt;&lt; std::endl; </span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;mymutex);</span><br><span class="line"></span><br><span class="line">        //é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹</span><br><span class="line">        pthread_cond_signal(&amp;mycv);</span><br><span class="line"></span><br><span class="line">        taskID ++;</span><br><span class="line"></span><br><span class="line">        //ä¼‘çœ 1ç§’</span><br><span class="line">        sleep(1);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return NULL;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">{</span><br><span class="line">    pthread_mutex_init(&amp;mymutex, NULL);</span><br><span class="line">    pthread_cond_init(&amp;mycv, NULL);</span><br><span class="line"></span><br><span class="line">    //åˆ›å»º 5 ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹</span><br><span class="line">    pthread_t consumerThreadID[5];</span><br><span class="line">    for (int i = 0; i &lt; 5; ++i)</span><br><span class="line">    {</span><br><span class="line">        pthread_create(&amp;consumerThreadID[i], NULL, consumer_thread, NULL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    //åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹</span><br><span class="line">    pthread_t producerThreadID;</span><br><span class="line">    pthread_create(&amp;producerThreadID, NULL, producer_thread, NULL);</span><br><span class="line"></span><br><span class="line">    pthread_join(producerThreadID, NULL);</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; 5; ++i)</span><br><span class="line">    {</span><br><span class="line">        pthread_join(consumerThreadID[i], NULL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    pthread_cond_destroy(&amp;mycv);</span><br><span class="line">    pthread_mutex_destroy(&amp;mymutex);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å¹¶æ‰§è¡Œä¸Šè¿°ç¨‹åºï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost testsemaphore]# g++ -g -o cv cv.cpp -lpthread</span><br><span class="line">[root@localhost testsemaphore]# ./cv</span><br><span class="line">produce a task, taskID: 0, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 0, threadID: 140571242518272</span><br><span class="line">produce a task, taskID: 1, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 1, threadID: 140571225732864</span><br><span class="line">produce a task, taskID: 2, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 2, threadID: 140571208947456</span><br><span class="line">produce a task, taskID: 3, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 3, threadID: 140571242518272</span><br><span class="line">produce a task, taskID: 4, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 4, threadID: 140571234125568</span><br><span class="line">produce a task, taskID: 5, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 5, threadID: 140571217340160</span><br><span class="line">produce a task, taskID: 6, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 6, threadID: 140571225732864</span><br><span class="line">produce a task, taskID: 7, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 7, threadID: 140571208947456</span><br><span class="line">produce a task, taskID: 8, threadID: 140571200554752</span><br><span class="line">handle a task, taskID: 8, threadID: 140571242518272</span><br><span class="line">...æ›´å¤šè¾“å‡ºç»“æœçœç•¥...</span><br></pre></td></tr></table></figure><p>æ¡ä»¶å˜é‡æœ€å…³é”®çš„ä¸€ä¸ªåœ°æ–¹å°±æ˜¯éœ€è¦æ¸…æ¥šåœ°è®°å¾— <code>pthread_cond_wait</code> åœ¨æ¡ä»¶æ»¡è¶³ä¸ä¸æ»¡è¶³æ—¶çš„ä¸¤ç§è¡Œä¸ºï¼Œè¿™æ˜¯éš¾ç‚¹ä¹Ÿæ˜¯<strong>é‡ç‚¹</strong>ï¼š</p><ul><li>å½“ <code>pthread_cond_wait</code> å‡½æ•°é˜»å¡æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾å…¶ç»‘å®šçš„äº’æ–¥ä½“ï¼Œå¹¶é˜»å¡çº¿ç¨‹ï¼Œå› æ­¤åœ¨è°ƒç”¨è¯¥å‡½æ•°å‰åº”è¯¥å¯¹äº’æ–¥ä½“æœ‰ä¸ªåŠ é”æ“ä½œï¼ˆä¸Šè¿°ä»£ç çš„ç¬¬ 34 è¡Œçš„ <code>pthread_mutex_lock(&amp;mymutex)</code>;ï¼‰ã€‚</li><li>å½“æ”¶åˆ°æ¡ä»¶ä¿¡å·æ—¶ï¼Œ <code>pthread_cond_wait</code> ä¼šè¿”å›å¹¶å¯¹å…¶ç»‘å®šçš„äº’æ–¥ä½“è¿›è¡ŒåŠ é”ï¼Œå› æ­¤åœ¨å…¶ä¸‹é¢ä¸€å®šæœ‰ä¸ªå¯¹äº’æ–¥ä½“è¿›è¡Œè§£é”çš„æ“ä½œï¼ˆä¸Šè¿°ä»£ç çš„ç¬¬ 45 è¡Œ <code>pthread_mutex_unlock(&amp;mymutex)</code>;ï¼‰ã€‚<h2 id="æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’"><a href="#æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’" class="headerlink" title="æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’"></a>æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’</h2>ä¸Šé¢å°†äº’æ–¥é‡å’Œæ¡ä»¶å˜é‡é…åˆä½¿ç”¨çš„ç¤ºä¾‹ä»£ç ä¸­æœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå°±æ˜¯ç”¨äº† <code>while</code> è¯­å¥ï¼Œé†’æ¥ ä¹‹åè¦å†æ¬¡åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while (tasks.empty())</span><br><span class="line">{                </span><br><span class="line">    pthread_cond_wait(&amp;mycv, &amp;mymutex);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>ä¸ºä»€ä¹ˆä¸å†™æˆï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (tasks.empty())</span><br><span class="line">{                </span><br><span class="line">    pthread_cond_wait(&amp;mycv, &amp;mymutex);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>ç­”æ¡ˆæ˜¯ä¸å¾—ä¸å¦‚æ­¤ã€‚å› ä¸ºå¯èƒ½æŸæ¬¡æ“ä½œç³»ç»Ÿå”¤é†’ <code>pthread_cond_wait</code> æ—¶ <code>tasks.empty()</code> å¯èƒ½ä»ç„¶ä¸º <code>true</code>ï¼Œè¨€ä¸‹ä¹‹æ„å°±æ˜¯æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šåœ¨ä¸€äº›æƒ…å†µä¸‹å”¤é†’æ¡ä»¶å˜é‡ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹å‘æ¡ä»¶å˜é‡å‘é€ä¿¡å·ï¼Œç­‰å¾…æ­¤æ¡ä»¶å˜é‡çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½ä¼šé†’æ¥ã€‚æˆ‘ä»¬å°†æ¡ä»¶å˜é‡çš„è¿™ç§è¡Œä¸ºç§°ä¹‹ä¸º <strong>è™šå‡å”¤é†’</strong> ï¼ˆspurious wakeupï¼‰ã€‚å› æ­¤å°†æ¡ä»¶ï¼ˆåˆ¤æ–­ <code>tasks.empty()</code> ä¸º <code>true</code>ï¼‰æ”¾åœ¨ä¸€ä¸ª <code>while</code> å¾ªç¯ä¸­æ„å‘³ç€å…‰å”¤é†’æ¡ä»¶å˜é‡ä¸è¡Œï¼Œè¿˜å¿…é¡»æ¡ä»¶æ»¡è¶³ç¨‹åºæ‰èƒ½ç»§ç»­æ‰§è¡Œæ­£å¸¸çš„é€»è¾‘ã€‚</li></ul><p>è¿™çœ‹èµ·æ¥è¿™åƒæ˜¯ä¸ª <code>bug</code>ï¼Œä½†å®ƒåœ¨ Linux ç³»ç»Ÿä¸­æ˜¯å®å®åœ¨åœ¨å­˜åœ¨çš„ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨è™šå‡å”¤é†’å‘¢ï¼Ÿä¸€ä¸ªåŸå› æ˜¯ï¼š<code>pthread_cond_wait</code> æ˜¯ <code>futex</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå±äºé˜»å¡å‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå½“ç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­çš„æ—¶å€™ï¼Œä¼šè¿”å› ï¹£1ï¼Œå¹¶ä¸”æŠŠ <code>errno</code> é”™è¯¯ç ç½®ä¸º <code>EINTR</code>ã€‚å¾ˆå¤šè¿™ç§ç³»ç»Ÿè°ƒç”¨ä¸ºäº†é˜²æ­¢è¢«ä¿¡å·ä¸­æ–­éƒ½ä¼šé‡å¯ç³»ç»Ÿè°ƒç”¨ï¼ˆå³å†æ¬¡è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pid_t r_wait(int *stat_loc)</span><br><span class="line">{</span><br><span class="line">    int retval;</span><br><span class="line">    //wait å‡½æ•°å› ä¸ºè¢«ä¿¡å·ä¸­æ–­å¯¼è‡´è°ƒç”¨å¤±è´¥ä¼šè¿”å› ï¹£1ï¼Œé”™è¯¯ç æ˜¯ EINTR  </span><br><span class="line">    //æ³¨æ„ï¼šè¿™é‡Œçš„ while å¾ªç¯ä½“æ˜¯ä¸€æ¡ç©ºè¯­å¥</span><br><span class="line">    while(((retval = wait(stat_loc)) == -1 &amp;&amp; (errno == EINTR));</span><br><span class="line"></span><br><span class="line">    return retval;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ <code>pthread_cond_wait</code> ç”¨é€”æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå‡è®¾ <code>pthread_cond_wait</code> å‡½æ•°è¢«ä¿¡å·ä¸­æ–­äº†ï¼Œåœ¨ <code>pthread_cond_wait</code> è¿”å›ä¹‹åï¼Œåˆ°é‡æ–°è°ƒç”¨ä¹‹å‰ï¼Œ<code>pthread_cond_signal</code> æˆ– <code>pthread_cond_broadcast</code> å¯èƒ½å·²ç»è°ƒç”¨è¿‡ã€‚ä¸€æ—¦é”™å¤±ï¼Œå¯èƒ½ç”±äºæ¡ä»¶ä¿¡å·ä¸å†äº§ç”Ÿï¼Œå†æ¬¡è°ƒç”¨ <code>pthread_cond_wait</code> å°†å¯¼è‡´ç¨‹åºæ— é™åˆ¶åœ°ç­‰å¾…ä¸‹å»ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå®å¯è™šå‡å”¤é†’ï¼Œä¹Ÿä¸èƒ½å†æ¬¡è°ƒç”¨ <code>pthread_cond_wait</code>ï¼Œä»¥å…é™·å…¥æ— ç©·çš„ç­‰å¾…ä¸­ã€‚</p><p>é™¤äº†ä¸Šé¢çš„ä¿¡å·å› ç´ å¤–ï¼Œè¿˜å­˜åœ¨ä»¥ä¸‹æƒ…å†µï¼šæ¡ä»¶æ»¡è¶³äº†å‘é€ä¿¡å·ï¼Œä½†ç­‰åˆ°è°ƒç”¨ <code>pthread_cond_wait</code> çš„çº¿ç¨‹å¾—åˆ° CPU èµ„æºæ—¶ï¼Œæ¡ä»¶åˆå†æ¬¡ä¸æ»¡è¶³äº†ã€‚</p><p>å¥½åœ¨æ— è®ºæ˜¯å“ªç§æƒ…å†µï¼Œé†’æ¥ä¹‹åå†æ¬¡æµ‹è¯•æ¡ä»¶æ˜¯å¦æ»¡è¶³å°±å¯ä»¥è§£å†³è™šå‡ç­‰å¾…çš„é—®é¢˜ã€‚è¿™å°±æ˜¯ä½¿ç”¨ <code>while</code> å¾ªç¯æ¥åˆ¤æ–­æ¡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>if</code> è¯­å¥çš„åŸå› ã€‚</p><h2 id="æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜"><a href="#æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜" class="headerlink" title="æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜"></a>æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜</h2><p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ï¼Œå¦‚æœä¸€ä¸ªæ¡ä»¶å˜é‡ä¿¡å·æ¡ä»¶äº§ç”Ÿæ—¶ï¼ˆè°ƒç”¨ <code>pthread_cond_signal</code> æˆ– <code>pthread_cond_broadcast</code>ï¼‰ï¼Œæ²¡æœ‰ç›¸å…³çš„çº¿ç¨‹è°ƒç”¨ <code>pthread_cond_wait</code> æ•è·è¯¥ä¿¡å·ï¼Œé‚£ä¹ˆè¯¥ä¿¡å·æ¡ä»¶å°±ä¼šæ°¸ä¹…æ€§åœ°ä¸¢å¤±äº†ï¼Œå†æ¬¡è°ƒç”¨ <code>pthread_cond_wait</code> ä¼šå¯¼è‡´æ°¸ä¹…æ€§çš„é˜»å¡ã€‚è¿™ç§æƒ…å†µåœ¨è®¾è®¡é‚£äº›æ¡ä»¶å˜é‡ä¿¡å·æ¡ä»¶åªä¼šäº§ç”Ÿä¸€æ¬¡çš„é€»è¾‘ä¸­å°¤å…¶éœ€è¦æ³¨æ„ï¼Œä¾‹å¦‚å‡è®¾ç°åœ¨æŸä¸ªç¨‹åºæœ‰ä¸€æ‰¹ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œå’Œä¸€ä¸ªåªäº§ç”Ÿä¸€æ¬¡æ¡ä»¶å˜é‡ä¿¡å·çš„çº¿ç¨‹ã€‚ä¸ºäº†è®©ä½ çš„ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹èƒ½æ­£å¸¸è¿è¡Œä¸é˜»å¡ï¼Œä½ çš„é€»è¾‘ä¸­ï¼Œä¸€å®šè¦ç¡®ä¿ç­‰å¾…çš„çº¿ç¨‹åœ¨äº§ç”Ÿæ¡ä»¶å˜é‡ä¿¡å·çš„çº¿ç¨‹å‘é€æ¡ä»¶ä¿¡å·ä¹‹å‰è°ƒç”¨ <code>pthread_cond_wait</code> ã€‚</p><blockquote><p>è¿™å’Œç”Ÿæ´»ä¸­çš„å¾ˆå¤šä¾‹å­ä¸€æ ·ï¼Œå³è®¸å¤šäº‹æƒ…ä½ åªæœ‰ä¸€æ¬¡æœºä¼šï¼Œå¿…é¡»æå‰å‡†å¤‡å¥½å†å»å°è¯•è¿™æ¬¡æœºä¼šï¼Œè¿™ä¸ªæœºä¼šä¸ä¼šç­‰å¾…ä½ çš„å‡†å¤‡ï¼Œä¸€æ—¦é”™è¿‡ï¼Œå°±ä¸ä¼šå†æœ‰ç¬¬äºŒæ¬¡æœºä¼šäº†ã€‚</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬èŠ‚ä»‹ç»äº†å­¦ä¹  Linux æ¡ä»¶å˜é‡éœ€è¦æŒæ¡çš„é‡éš¾ç‚¹çŸ¥è¯†ï¼Œæ¡ä»¶å˜é‡æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§å¤šçº¿ç¨‹ç¼–ç¨‹åŒæ­¥æŠ€æœ¯ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯é¢è¯•é«˜é¢‘é—®é¢˜ä¹‹ä¸€ï¼Œå»ºè®®æ‰“ç®—ä»äº‹ç›¸å…³å·¥ä½œçš„è¯»è€…åŠ¡å¿…ç†è§£å’Œç†Ÿç»ƒä½¿ç”¨å®ƒã€‚</p><hr><p><a class="link" target="_blank" rel="noopener" href="https://github.com/balloonwj/gitchat_cppmultithreadprogramming">ç‚¹å‡»è¿™é‡Œä¸‹è½½è¯¾ç¨‹æºä»£ç <i class="fas fa-external-link-alt"></i></a></p><p>æ¥æº:<a class="link" target="_blank" rel="noopener" href="https://gitbook.cn/gitchat/column/5d11e726820bf61799b8277f">èŒƒè ¡ã€ŠC/C++ å¤šçº¿ç¨‹ç¼–ç¨‹ç²¾é«“ã€‹<i class="fas fa-external-link-alt"></i></a></p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li>æœ¬æ–‡æ ‡é¢˜ï¼šLinux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡</li><li>æœ¬æ–‡ä½œè€…ï¼šç™½ç¾½è¿‘å¢¨</li><li>åˆ›å»ºæ—¶é—´ï¼š2021-10-18 13:56:20</li><li>æœ¬æ–‡é“¾æ¥ï¼šhttps://keep.xpoet.cn/2021/10/18/CPP-multithreaded-12/</li><li>ç‰ˆæƒå£°æ˜ï¼šæœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li><li class="tag-item"><a href="/tags/Windows/">#Windows</a>&nbsp;</li><li class="tag-item"><a href="/tags/C-%E5%BC%80%E5%8F%91/">#C++ å¼€å‘</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2021/10/18/CPP-multithreaded-13/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Linux çº¿ç¨‹åŒæ­¥ä¹‹è¯»å†™é”</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2021/10/18/CPP-multithreaded-11/"><span class="title flex-center"><span class="post-nav-title-item">Linux çº¿ç¨‹åŒæ­¥ä¹‹ä¿¡å·é‡</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comment-anchor"></div><div class="comment-area-title"><i class="fas fa-comments">&nbsp;è¯„è®º</i></div><div class="valine-container"><script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><div id="vcomments"></div><script data-pjax>function loadValine(){function e(e){switch(e){case"en":return"Author";case"zh-CN":return"åšä¸»";default:return"Master"}}new Valine({el:"#vcomments",appId:"irqOqaGORMEoxUV1bBigEGyr-gzGzoHsz",appKey:"Dkd9JB0KYotx5nS6IA6PKB6f",meta:["nick","mail","link"],avatar:"wavatar",enableQQ:!0,placeholder:"ğŸ˜œ å°½æƒ…åæ§½å§~",lang:"zh-CN".toLowerCase()});const a=setInterval(()=>{const n=document.querySelectorAll("#vcomments .vcards .vcard");if(n.length>0){let t="ç™½ç¾½è¿‘å¢¨";if(t)for(let a of n){const n=a.querySelector(".vhead .vnick"),r=n.innerHTML;r===t&&(n.innerHTML=`${r} <span class="author">${e(KEEP.hexo_config.language)}</span>`)}clearInterval(a)}else clearInterval(a)},2e3)}{const e=setTimeout(()=>{loadValine(),clearTimeout(e)},1e3)}</script></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span> - 2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ç™½ç¾½è¿‘å¢¨</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li><li class="go-comment"><i class="fas fa-comment"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item rss flex-center"><a class="flex-center" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9F%B3%E4%B9%90%E5%B0%8F%E6%B8%AF"><span class="nav-number">1.</span> <span class="nav-text">éŸ³ä¹å°æ¸¯</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B9%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number"></span> <span class="nav-text">Linux çº¿ç¨‹åŒæ­¥ä¹‹æ¡ä»¶å˜é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number"></span> <span class="nav-text">ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%B8%8E%E4%BA%92%E6%96%A5%E4%BD%93%E5%AF%B9%E8%B1%A1%E7%BB%93%E5%90%88"><span class="nav-number"></span> <span class="nav-text">æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number"></span> <span class="nav-text">æ¡ä»¶å˜é‡çš„ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E7%9A%84%E8%99%9A%E5%81%87%E5%94%A4%E9%86%92"><span class="nav-number"></span> <span class="nav-text">æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E4%BF%A1%E5%8F%B7%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="nav-number"></span> <span class="nav-text">æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number"></span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script></div><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>